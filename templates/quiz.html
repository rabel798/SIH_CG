{% extends "base.html" %}

{% block title %}Career Quiz - CareerGuide{% endblock %}

{% block content %}
<section class="py-20">
    <div class="container px-4 max-w-2xl mx-auto">
        {% if has_completed %}
        <!-- Quiz Already Completed View -->
        <div class="text-center mb-8">
            <div style="width: 4rem; height: 4rem; background-color: var(--accent); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1.5rem;">
                <svg style="width: 2rem; height: 2rem; color: var(--accent-foreground);" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
            </div>
            <h1 style="font-size: 1.5rem; font-weight: bold; margin-bottom: 1rem;">Quiz Already Completed!</h1>
            <p style="color: var(--muted-foreground); margin-bottom: 2rem;">
                You have already completed the career aptitude quiz. You can view your results or retake the quiz if you'd like to update your responses.
            </p>
            <div class="flex flex-col sm:flex-row gap-4 justify-center items-center">
                <a href="/results" class="btn btn-primary btn-lg">View Results</a>
                <button id="retakeQuizBtn" class="btn btn-outline btn-lg">Retake Quiz</button>
            </div>
        </div>
        {% else %}
        <!-- Quiz Interface -->
        <div class="mb-8" id="quizInterface" style="display: block;">
            <div class="flex justify-between items-center mb-4">
                <h1 style="font-size: 1.5rem; font-weight: bold;">Career Aptitude Quiz</h1>
                <span id="questionCounter" style="font-size: 0.875rem; color: var(--muted-foreground);">
                    Question 1 of {{ questions|length }}
                </span>
            </div>
            <div class="progress">
                <div id="progressBar" class="progress-bar" style="width: {{ (1 / questions|length * 100) }}%;"></div>
            </div>
        </div>
        {% endif %}

        {% if not has_completed %}
        <div class="card mb-8">
            <div class="card-header">
                <h2 id="questionText" class="card-title text-balance">{{ questions[0].question }}</h2>
                <p class="card-description">Select the option that best describes your preference</p>
                <p style="font-size: 0.875rem; color: var(--muted-foreground); margin-top: 0.5rem;">
                    ðŸ’¡ Tip: Click anywhere on an option, or use keys 1-5 to select quickly
                </p>
            </div>
            <div class="card-content">
                <div class="radio-group" id="answerOptions">
                    <div class="radio-item">
                        <input type="radio" name="answer" value="5" id="option-5" class="radio-input">
                        <label for="option-5" class="radio-label">Strongly Agree</label>
                    </div>
                    <div class="radio-item">
                        <input type="radio" name="answer" value="4" id="option-4" class="radio-input">
                        <label for="option-4" class="radio-label">Agree</label>
                    </div>
                    <div class="radio-item">
                        <input type="radio" name="answer" value="3" id="option-3" class="radio-input">
                        <label for="option-3" class="radio-label">Neutral</label>
                    </div>
                    <div class="radio-item">
                        <input type="radio" name="answer" value="2" id="option-2" class="radio-input">
                        <label for="option-2" class="radio-label">Disagree</label>
                    </div>
                    <div class="radio-item">
                        <input type="radio" name="answer" value="1" id="option-1" class="radio-input">
                        <label for="option-1" class="radio-label">Strongly Disagree</label>
                    </div>
                </div>
            </div>
        </div>

        <div class="flex justify-between items-center">
            <button id="prevBtn" class="btn btn-outline" disabled>Previous</button>

            <div class="flex gap-2" id="progressDots">
            </div>

            <button id="nextBtn" class="btn btn-primary">Next</button>
        </div>

        <div class="mt-8 card" style="background-color: var(--muted);">
            <div class="card-content text-center">
                <p style="font-size: 0.875rem; color: var(--muted-foreground);">
                    Your progress is automatically saved. You can return to complete the quiz later if needed.
                </p>
            </div>
        </div>
        {% endif %}
    </div>
</section>
{% endblock %}

{% block scripts %}
<script>
    const questions = {{ questions | tojson }};
    const hasCompleted = {{ has_completed | tojson }};
    let currentQuestion = 0;
    let answers = [];

    document.addEventListener('DOMContentLoaded', function() {
        console.log('Quiz page loaded');
        
        // Handle retake quiz button
        const retakeBtn = document.getElementById('retakeQuizBtn');
        if (retakeBtn) {
            retakeBtn.addEventListener('click', function() {
                if (confirm('Are you sure you want to retake the quiz? This will clear your previous results.')) {
                    fetch('/clear_quiz_progress', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            showToast('Quiz progress cleared. Starting fresh quiz...', 'success');
                            setTimeout(() => window.location.reload(), 1000);
                        } else {
                            showToast('Error clearing quiz progress. Please try again.', 'error');
                        }
                    })
                    .catch(error => {
                        console.error('Error clearing quiz progress:', error);
                        showToast('Error clearing quiz progress. Please try again.', 'error');
                    });
                }
            });
        }

        // Initialize quiz if not completed
        if (!hasCompleted) {
            loadProgress();
            setupQuiz();
        }
    });

    function setupQuiz() {
        console.log('Setting up quiz...');
        
        // Setup radio interactions
        const radioItems = document.querySelectorAll('.radio-item');
        radioItems.forEach((item, index) => {
            const radio = item.querySelector('.radio-input');
            item.addEventListener('click', (e) => {
                e.preventDefault();
                radio.checked = true;
                updateRadioSelection();
            });
            radio.addEventListener('change', () => {
                updateRadioSelection();
            });
        });

        // Setup keyboard navigation
        document.addEventListener('keydown', (e) => {
            if (e.key >= '1' && e.key <= '5') {
                const radio = document.querySelector(`input[value="${e.key}"]`);
                if (radio) {
                    radio.checked = true;
                    updateRadioSelection();
                }
            } else if (e.key === 'Enter') {
                const nextBtn = document.getElementById('nextBtn');
                if (nextBtn && !nextBtn.disabled) {
                    nextBtn.click();
                }
            }
        });

        // Setup next/previous buttons
        const nextBtn = document.getElementById('nextBtn');
        const prevBtn = document.getElementById('prevBtn');
        
        if (nextBtn) {
            nextBtn.addEventListener('click', handleNext);
        }
        
        if (prevBtn) {
            prevBtn.addEventListener('click', handlePrevious);
        }
    }

    function handleNext() {
        console.log('Next button clicked');
        const selectedAnswer = document.querySelector('input[name="answer"]:checked');
        if (!selectedAnswer) {
            showToast('Please select an answer before proceeding.', 'error');
            return;
        }

        saveCurrentAnswer();

        if (currentQuestion < questions.length - 1) {
            currentQuestion++;
            updateUI();
            loadCurrentAnswer();
        } else {
            if (answers.length < questions.length) {
                showToast('Please answer all questions before submitting.', 'error');
                return;
            }
            
            showToast('Quiz completed! Analyzing your responses...', 'success');
            
            fetch('/calculate_results', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ answers: answers })
            })
            .then(response => response.json())
            .then(data => {
                if (typeof updateNavigation === 'function') {
                    updateNavigation(true, null, false);
                }
                setTimeout(() => window.location.href = '/results', 1000);
            })
            .catch(error => {
                console.error('Error calculating results:', error);
                setTimeout(() => window.location.href = '/results', 1000);
            });
        }
    }

    function handlePrevious() {
        console.log('Previous button clicked');
        saveCurrentAnswer();
        
        if (currentQuestion > 0) {
            currentQuestion--;
            updateUI();
            loadCurrentAnswer();
        }
    }

    function loadProgress() {
        fetch('/get_quiz_progress')
            .then(response => response.json())
            .then(data => {
                answers = data.answers || [];
                currentQuestion = data.currentQuestion || 0;
                updateUI();
                loadCurrentAnswer();
            });
    }

    function updateUI() {
        const questionCounter = document.getElementById('questionCounter');
        const progressBar = document.getElementById('progressBar');
        const questionText = document.getElementById('questionText');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        
        if (questionCounter) {
            questionCounter.textContent = `Question ${currentQuestion + 1} of ${questions.length}`;
        }
        
        if (progressBar) {
            const progress = ((currentQuestion + 1) / questions.length) * 100;
            progressBar.style.width = `${progress}%`;
        }
        
        if (questionText) {
            questionText.textContent = questions[currentQuestion].question;
        }
        
        if (prevBtn) {
            prevBtn.disabled = currentQuestion === 0;
        }
        
        if (nextBtn) {
            nextBtn.textContent = currentQuestion === questions.length - 1 ? 'Submit Quiz' : 'Next';
        }
        
        updateProgressDots();
    }

    function updateProgressDots() {
        const dotsContainer = document.getElementById('progressDots');
        if (!dotsContainer) return;
        
        dotsContainer.innerHTML = '';
        
        for (let i = 0; i < questions.length; i++) {
            const dot = document.createElement('div');
            dot.style.cssText = `
                width: 0.5rem; 
                height: 0.5rem; 
                border-radius: 50%; 
                background-color: ${i <= currentQuestion ? 'var(--accent)' : 'var(--muted)'};
                ${i === currentQuestion ? 'box-shadow: 0 0 0 2px var(--accent), 0 0 0 4px var(--background);' : ''}
            `;
            dotsContainer.appendChild(dot);
        }
    }

    function loadCurrentAnswer() {
        const existingAnswer = answers.find(a => a.questionId === questions[currentQuestion].id);
        if (existingAnswer) {
            const radio = document.querySelector(`input[value="${existingAnswer.answer}"]`);
            if (radio) radio.checked = true;
        } else {
            document.querySelectorAll('input[name="answer"]').forEach(radio => {
                radio.checked = false;
            });
        }
        updateRadioSelection();
    }

    function saveCurrentAnswer() {
        const selectedAnswer = document.querySelector('input[name="answer"]:checked');
        if (!selectedAnswer) return false;

        const questionId = questions[currentQuestion].id;
        const answerValue = parseInt(selectedAnswer.value);

        answers = answers.filter(a => a.questionId !== questionId);
        answers.push({ questionId, answer: answerValue });

        fetch('/save_quiz_progress', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ answers, currentQuestion })
        });

        return true;
    }

    function updateRadioSelection() {
        const radioItems = document.querySelectorAll('.radio-item');
        radioItems.forEach(item => {
            const radio = item.querySelector('.radio-input');
            if (radio.checked) {
                item.classList.add('selected');
            } else {
                item.classList.remove('selected');
            }
        });
    }
</script>
{% endblock %}
